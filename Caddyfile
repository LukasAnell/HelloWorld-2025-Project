# HTTP vhost (for Cloudflare Flexible or initial reachability). No TLS/redirects here.
http://resumereviewer.lukasanell.org {
    encode gzip zstd

    route {
        # API endpoints first (non-stripping). Do NOT use handle_path here.
        handle /analyze* {
            reverse_proxy backend:5001
        }
        handle /health {
            reverse_proxy backend:5001
        }

        # Optional: debug Ollama; stripping is fine for nested paths
        handle_path /ollama* {
            reverse_proxy ollama:11434
        }

        # Static site fallback
        handle {
            root * /srv
            try_files {path} /index.html
            file_server
            header {
                X-Content-Type-Options "nosniff"
                X-Frame-Options "DENY"
                Referrer-Policy "no-referrer-when-downgrade"
                Permissions-Policy "geolocation=(), microphone()"
            }
        }
    }

    log { output file /data/access.log }
}

# HTTPS vhost (normal operation with proper TLS)
resumereviewer.lukasanell.org {
    tls lukasmanell@gmail.com
    encode gzip zstd

    route {
        # API endpoints first (non-stripping). Do NOT use handle_path here.
        handle /analyze* {
            reverse_proxy backend:5001
        }
        handle /health {
            reverse_proxy backend:5001
        }

        # Optional: debug Ollama; stripping is fine for nested paths
        handle_path /ollama* {
            reverse_proxy ollama:11434
        }

        # Static site fallback
        handle {
            root * /srv
            try_files {path} /index.html
            file_server
            header {
                Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
                X-Content-Type-Options "nosniff"
                X-Frame-Options "DENY"
                Referrer-Policy "no-referrer-when-downgrade"
                Permissions-Policy "geolocation=(), microphone()"
            }
        }
    }

    log { output file /data/access.log }
}